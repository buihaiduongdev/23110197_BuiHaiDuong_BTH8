<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-list img {
            max-width: 100px;
            max-height: 100px;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h1 class="mb-4">Product Management</h1>

    <!-- Product List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2>Product List</h2>
            <button class="btn btn-primary" onclick="getAllProducts(true)">Refresh Products</button>
        </div>
        <div class="card-body">
            <div id="product-list" class="product-list"></div>
        </div>
    </div>

    <!-- Create and Update Forms -->
    <div class="row mt-4">
        <!-- Create Product Form -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2>Create Product</h2>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="createName" class="form-label">Product Name:</label>
                        <input type="text" class="form-control" id="createName" placeholder="Enter product name">
                    </div>
                    <div class="mb-3">
                        <label for="createPrice" class="form-label">Unit Price:</label>
                        <input type="number" class="form-control" id="createPrice" placeholder="Enter price">
                    </div>
                    <div class="mb-3">
                        <label for="createQuantity" class="form-label">Quantity:</label>
                        <input type="number" class="form-control" id="createQuantity" placeholder="Enter quantity">
                    </div>
                    <div class="mb-3">
                        <label for="createCategory" class="form-label">Category:</label>
                        <select class="form-select" id="createCategory"></select>
                    </div>
                    <div class="mb-3">
                        <label for="createImages" class="form-label">Images:</label>
                        <input type="file" class="form-control" id="createImages" multiple>
                    </div>
                    <button class="btn btn-success" onclick="createProduct()">Create</button>
                </div>
            </div>
        </div>

        <!-- Update Product Form -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2>Update Product</h2>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="updateId" class="form-label">Product ID to Update:</label>
                        <input type="number" class="form-control" id="updateId" placeholder="Enter product ID">
                    </div>
                    <div class="mb-3">
                        <label for="updateName" class="form-label">New Product Name:</label>
                        <input type="text" class="form-control" id="updateName" placeholder="Enter new name">
                    </div>
                    <div class="mb-3">
                        <label for="updatePrice" class="form-label">New Unit Price:</label>
                        <input type="number" class="form-control" id="updatePrice" placeholder="Enter new price">
                    </div>
                    <div class="mb-3">
                        <label for="updateQuantity" class="form-label">New Quantity:</label>
                        <input type="number" class="form-control" id="updateQuantity" placeholder="Enter new quantity">
                    </div>
                    <div class="mb-3">
                        <label for="updateCategory" class="form-label">New Category:</label>
                        <select class="form-select" id="updateCategory"></select>
                    </div>
                    <div class="mb-3">
                        <label for="updateImages" class="form-label">New Images:</label>
                        <input type="file" class="form-control" id="updateImages" multiple>
                    </div>
                    <button class="btn btn-warning" onclick="updateProduct()">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Display -->
    <div class="card mt-4">
        <div class="card-header">
            <h2>API Result</h2>
        </div>
        <div class="card-body">
            <pre id="result-display">API responses will be shown here.</pre>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const resultDisplay = document.getElementById('result-display');
    const productListDiv = document.getElementById('product-list');
    const createCategorySelect = document.getElementById('createCategory');
    const updateCategorySelect = document.getElementById('updateCategory');

    function displayResult(data, status) {
        resultDisplay.textContent = `Status: ${status}\n\n${JSON.stringify(data, null, 2)}`;
    }

    async function fetchCategories() {
        try {
            const response = await fetch('/api/category');
            if (!response.ok) return;
            const categories = await response.json();

            createCategorySelect.innerHTML = '';
            updateCategorySelect.innerHTML = '';

            categories.forEach(cat => {
                const option1 = new Option(cat.name, cat.id);
                const option2 = new Option(cat.name, cat.id);
                createCategorySelect.add(option1);
                updateCategorySelect.add(option2);
            });
        } catch (error) {
            console.error("Failed to load categories:", error);
        }
    }

    async function getAllProducts(showResult = false) {
        try {
            const response = await fetch('/api/product');
            const products = await response.json(); 

            if (showResult) {
                displayResult(products, response.status);
            }

            if (!response.ok) {
                productListDiv.innerHTML = '<div class="alert alert-danger">Could not load products.</div>';
                return;
            }

            let tableHtml = '<table class="table table-striped table-bordered"><thead><tr><th>ID</th><th>Name</th><th>Price</th><th>Quantity</th><th>Category</th><th>Images</th><th>Actions</th></tr></thead><tbody>';

            for (const product of products) {
                tableHtml += `<tr>
                    <td>${product.id}</td>
                    <td>${product.productName}</td>
                    <td>${product.unitPrice}</td>
                    <td>${product.quantity}</td>
                    <td>${product.category ? product.category.name : 'N/A'}</td>
                    <td>${product.images ? product.images.split(',').map(img => `<img src="/uploads/${img}" alt="${img}" class="img-thumbnail">`).join(' ') : 'None'}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">Delete</button></td>
                </tr>`;
            }

            tableHtml += '</tbody></table>';
            productListDiv.innerHTML = tableHtml;
        } catch (error) {
            productListDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            if (showResult) {
                displayResult({ error: error.message }, 'Error');
            }
        }
    }

    async function createProduct() {
        const formData = new FormData();
        formData.append('productName', document.getElementById('createName').value);
        formData.append('unitPrice', document.getElementById('createPrice').value);
        formData.append('quantity', document.getElementById('createQuantity').value);
        formData.append('categoryId', document.getElementById('createCategory').value);

        const files = document.getElementById('createImages').files;
        for (let i = 0; i < files.length; i++) {
            formData.append('images', files[i]);
        }

        try {
            const response = await fetch('/api/product', { method: 'POST', body: formData });
            const data = await response.json();
            displayResult(data, response.status);
            if(response.ok) await getAllProducts();
        } catch (error) {
            displayResult({ error: error.message }, 'Error');
        }
    }

    async function updateProduct() {
        const id = document.getElementById('updateId').value;
        if (!id) {
            alert('Product ID is required.');
            return;
        }

        const formData = new FormData();
        formData.append('productName', document.getElementById('updateName').value);
        formData.append('unitPrice', document.getElementById('updatePrice').value);
        formData.append('quantity', document.getElementById('updateQuantity').value);
        formData.append('categoryId', document.getElementById('updateCategory').value);

        const files = document.getElementById('updateImages').files;
        for (let i = 0; i < files.length; i++) {
            formData.append('images', files[i]);
        }

        try {
            const response = await fetch(`/api/product/${id}`, { method: 'PUT', body: formData });
            const data = await response.json();
            displayResult(data, response.status);
            if(response.ok) await getAllProducts();
        } catch (error) {
            displayResult({ error: error.message }, 'Error');
        }
    }

    async function deleteProduct(id) {
        if (!confirm(`Are you sure you want to delete product with ID ${id}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/product/${id}`, { method: 'DELETE' });
            if (response.ok) {
                // For DELETE, response might not have a body, so we display a custom message
                displayResult({ message: `Product ${id} deleted` }, response.status);
                await getAllProducts();
            } else {
                const data = await response.json().catch(() => ({}));
                displayResult(data, response.status);
            }
        } catch (error) {
            displayResult({ error: error.message }, 'Error');
        }
    }

    (async () => {
        await fetchCategories();
        await getAllProducts(true); // Show initial list in result display
    })();
</script>

</body>
</html>
